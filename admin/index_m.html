<html>

<head>

    <!-- Load ioBroker scripts and styles-->
    <link rel="stylesheet" type="text/css" href="../../css/adapter.css" />
    <link rel="stylesheet" type="text/css" href="../../lib/css/materialize.css">
    <link rel="stylesheet" type="text/css" href="../../lib/css/fancytree/ui.fancytree.min.css" />
    <link type="text/css" rel="stylesheet" href="../../lib/css/themes/jquery-ui/default/jquery-ui.min.css">
    <link rel="stylesheet" type="text/css" href="../../lib/css/iob/selectID.css" />

    <script type="text/javascript" src="../../lib/js/jquery-3.2.1.min.js"></script>
    <script type="text/javascript" src="../../lib/js/jquery-ui-1.10.3.full.min.js"></script>
    <script type="text/javascript" src="../../lib/js/jquery-ui.min.js"></script>
    <script type="text/javascript" src="../../lib/js/jquery.fancytree-all.min.js"></script>
    <script type="text/javascript" src="../../lib/js/materialize.js"></script>
    <script type="text/javascript" src="../../socket.io/socket.io.js"></script>
    <script type="text/javascript" src="../../lib/js/selectID.js"></script>
    <script type="text/javascript" src="../../js/translate.js"></script>
    <script type="text/javascript" src="../../js/adapter-settings.js"></script>
    <script type="text/javascript" src="words.js"></script>

    <!-- Load our own files -->
    <link rel="stylesheet" type="text/css" href="style.css" />

    <script type="text/javascript">

        let device = [];
        let selectId;
        let alexaID = [];
        let sayitID = [];
        let deviceID = [];
        let whatsappID = [];
        let arrTelegramUser = [];
        let pushoverID = [];
        let emailID = [];
        let customTypeID = [];
        let defaultTypeID = [];
        let valStates = [];
        let alexa = [];
        let sayit = [];
        let devices = [];
        let whatsapp = [];
        let deviceTypes = [];
        let firstName = []; // telegram firstname user
        let pushover = [];
        let email = [];

        let device_counter;
        let alexa_counter;
        let sayit_counter;
        let whatsapp_counter;
        let telegram_counter;
        let pushover_counter;
        let email_counter;

        let alexaFinal = [];
        let sayitFinal = [];
        let whatsappFinal = [];
        let devicesFinal = [];
        let customTypeIDFinal = [];
        let defaultTypeIDFinal = [];
        let telegramFinal = [];
        let pushoverFinal = [];
        let emailFinal = [];
        let curDevice = null
        let varTrue = false;
        let active = false;

        async function loadUser(settings, onChange) {
            $('.value').each(function () {
                const $key = $(this);
                const id = $key.attr('id');
                if ($key.attr('type') === 'checkbox') {
                    // do not call onChange direct, because onChange could expect some arguments
                    $key.prop('checked', settings[id])
                        .on('change', () => onChange())
                        ;
                }
                else {
                    // do not call onChange direct, because onChange could expect some arguments
                    $key.val(settings[id])
                        .on('change', () => onChange())
                        .on('keyup', () => onChange())
                        ;
                };
            });
        };

        // This will be called by the admin adapter when the settings page loads
        async function load(settings, onChange) {
            if (!settings) return;
            let namespace = `${adapter}.${instance}`;

            socket.emit('getState', `system.adapter.${namespace}.alive`, async function (err, state) {
                active = await /*common.enabled ||*/ (state && state.val);
                if (!active) {
                    await $(`#test`).html(`<div class="collapsible-header red lighten-1"><i class="large material-icons">error_outline</i>Please activate the device-reminder.${instance} instance!</div>`);
                    await $('.btn-save, .btn-save-close').addClass('disabled');
                } else {

                    deviceID = settings.deviceID || []; // device ID native anlegen
                    device = settings.device || []; // devices native anlegen
                    alexaID = settings.alexaID || []; // alexaID native anlegen 
                    sayitID = settings.sayitID || []; // sayit ID native anlegen
                    whatsappID = settings.whatsappID || []; // whatsapp ID native anlegen
                    pushoverID = settings.pushoverID || []; // pushover ID native anlegen
                    emailID = settings.emailID || []; // emailID native anlegen

                    
                    customTypeID = settings.customTypeID || [];
                    defaultTypeID = settings.defaultTypeID || [];
                    device_final = settings.device_final || []; // output -> main.js

                    // create own device status
                    if (settings.valStates.length === 0) {
                        valStates = [{ "stateAction": "in action", "stateStandby": "standby", "stateOff": "off" }];
                    } else {
                        let objTemp = {};
                        objTemp = settings.valStates[0];
                        if (objTemp.stateAction === "") {
                            objTemp.stateAction = "in action";
                        };
                        if (objTemp.stateStandby === "") {
                            objTemp.stateStandby = "standby";
                        };
                        if (objTemp.stateOff === "") {
                            objTemp.stateOff = "off";
                        };
                        settings.valStates[0] = objTemp;
                        valStates = settings.valStates;
                    };

                    // counter ID
                    settings.device_counter = ctrlCntr(settings.device_counter);
                    settings.alexa_counter = ctrlCntr(settings.alexa_counter);
                    settings.sayit_counter = ctrlCntr(settings.sayit_counter);
                    settings.whatsapp_counter = ctrlCntr(settings.whatsapp_counter);
                    settings.telegram_counter = ctrlCntr(settings.telegram_counter);
                    settings.pushover_counter = ctrlCntr(settings.pushover_counter);
                    settings.email_counter = ctrlCntr(settings.email_counter);

                    function ctrlCntr(cntr) {
                        if (cntr == undefined) {
                            cntr = 0;
                        };
                        console.log(cntr);
                        return cntr;
                    };

                    device_counter = settings.device_counter;
                    alexa_counter = settings.alexa_counter;
                    sayit_counter = settings.sayit_counter;
                    whatsapp_counter = settings.whatsapp_counter;
                    telegram_counter = settings.telegram_counter;
                    pushover_counter = settings.pushover_counter;
                    email_counter = settings.email_counter;
                    custom_device_counter = settings.custom_device_counter;

                    await readUser('start');

                    $('#fill-dynamic-table').addClass('disabled');

                    loadUser(settings, onChange);

                    setTimeout(function () {
                        showHeader('dynamicTable', 'idAlexa', alexa);
                        showHeader('dynamicTable', 'idsayit', sayit);
                        showHeader('dynamicTable', 'idTelegram', firstName);
                        showHeader('dynamicTable', 'idWhatsapp', whatsapp);
                        showHeader('dynamicTable', 'idPushover', pushover);
                        showHeader('dynamicTable', 'idEmail', email);
                    }, 200);

                    onChange(false);

                    // reinitialize all the Materialize labels on the page if you are dynamically adding inputs:
                    setTimeout(function () {
                        values2table('deviceID', deviceID, onChange); //deviceID
                        values2table('alexaID', alexaID, onChange); //alexa
                        values2table('sayitID', sayitID, onChange); //sayit
                        values2table('whatsappID', whatsappID, onChange); // whatsapp
                        values2table('pushoverID', pushoverID, onChange); // pushover
                        values2table('emailID', emailID, onChange); // email
                        values2table('customTypeID', customTypeID, onChange); // custom devices
                        values2table('defaultTypeID', defaultTypeID, onChange); // custom devices
                        values2table('valStates', valStates, onChange)
                        $('#disableFirstField').find('td:first-child .values-input').prop('disabled', true);

                    }, 200);
                    setTimeout(function () {
                        createDynamicTable(settings, onChange, device); // create dynamic table "device"
                        $('#dynamicTableLoading, #dynamicTableLoadingText').css('display', 'none'); // ladekringel
                    }, 200);

                    if (M) M.updateTextFields();

                    if (varTrue == false) clickButton(onChange);

                    $('.collapsible').collapsible();
                };
            });

        };

        //##################################################################################################
        //##################################################################################################
        //############################################ Load End ############################################
        //##################################################################################################
        //##################################################################################################

        //##################################################################################################
        //##################################################################################################
        //############################################ save start ##########################################
        //##################################################################################################
        //##################################################################################################

        async function save(callback) {
            let obj = {};
            obj = createSettings();

            // create messaging devices
            obj.alexaFinal = createArray(JSON.parse(JSON.stringify(obj.alexaID)), "alexa");
            obj.sayitFinal = createArray(JSON.parse(JSON.stringify(obj.sayitID)), "sayit");
            obj.whatsappFinal = createArray(JSON.parse(JSON.stringify(obj.whatsappID)), "whatsapp");
            obj.customTypeIDFinal = createArray(JSON.parse(JSON.stringify(obj.customTypeID)), "typeID");
            obj.defaultTypeIDFinal = createArray(JSON.parse(JSON.stringify(obj.defaultTypeID)), "typeID");
            obj.telegramFinal = createArray(JSON.parse(JSON.stringify(obj.telegramID)), "telegram");
            obj.pushoverFinal = createArray(JSON.parse(JSON.stringify(obj.pushoverID)), "pushover");
            obj.emailFinal = createArray(JSON.parse(JSON.stringify(obj.emailID)), "email"); 

        
            function createArray(obj, type) {
                let objTemp = {};
                for (const id in obj) {
                    if (type === "alexa" || type === "sayit") {
                        timeMin = "";
                        timeMax = "";
                        let timeMinHourTemp = ``;
                        let timeMinMinTemp = ``;
                        let timeMaxHourTemp = ``;
                        let timeMaxMinTemp = ``;
                        if (obj[id].timeMinHour !== ``
                            && obj[id].timeMinMin !== ``
                            && obj[id].timeMaxHour !== ``
                            && obj[id].timeMaxMin !== ``) {
                            timeMinHourTemp = obj[id].timeMinHour;
                            timeMinMinTemp = obj[id].timeMinMin;
                            timeMaxHourTemp = obj[id].timeMaxHour;
                            timeMaxMinTemp = obj[id].timeMaxMin;
                            timeMin = `${timeMinHourTemp}:${timeMinMinTemp}`;
                            timeMax = `${timeMaxHourTemp}:${timeMaxMinTemp}`;
                        };
                        if (obj[id].volume < 0 || obj[id].volume > 100 || obj[id].volume === undefined || obj[id].volume === '') {
                            obj[id].volume = 50;
                        };
                    };

                    switch (type) {
                        case "alexa": {
                            objTemp[obj[id].id] = {
                                name: obj[id].name,
                                path: obj[id].path,
                                volume: obj[id].volume,
                                timeMin: timeMin,
                                timeMax: timeMax
                            };
                            break;
                        };
                        case "sayit": {
                            objTemp[obj[id].id] = {
                                name: obj[id].name,
                                path: obj[id].path,
                                timeMin: timeMin,
                                timeMax: timeMax,
                                volume: obj[id].volume
                            };
                            break;
                        };
                        case "whatsapp": {
                            objTemp[obj[id].id] = {
                                name: obj[id].name,
                                path: obj[id].path,
                            };
                            break;
                        };
                        case "typeID": {
                            objTemp[obj[id].id] = {
                                name: obj[id].name,
                                startVal: obj[id].startVal,
                                endVal: obj[id].endVal,
                                startCount: obj[id].startCount,
                                endCount: obj[id].endCount
                            };
                            break;
                        };
                        case "telegram": {
                            objTemp[obj[id].id] = {
                                name: obj[id].nameFinal,
                                inst: obj[id].inst
                            };
                            break;
                        };
                        case "pushover": {
                            objTemp[obj[id].id] = {
                                name: obj[id].name,
                                inst: obj[id].inst,
                                prio: obj[id].prio,
                                sound: obj[id].sound,
                            };
                            break;
                        };
                        case "email": {
                            objTemp[obj[id].id] = {
                                name: obj[id].name,
                                inst: obj[id].emailFrom,
                                prio: obj[id].emailTo
                            };
                            break;
                        };
                    };
                };
                return objTemp;
            };

            obj.devicesFinal = createDevicesFinal(JSON.parse(JSON.stringify(obj.device)), obj.deviceID);

            function createDevicesFinal(obj, arr) {
                let objTemp = {};

                for (const i in obj) {
                    for (const j in arr) {
                        if (obj[i].id == arr[j].id) {
                            if (obj[i].enabled) {

                                objTemp[obj[i].id] = {
                                    name: arr[j].name,
                                    type: arr[j].type,
                                    pathConsumption: arr[j].consumption,
                                    pathSwitch: arr[j].switch,
                                    startText: arr[j].startText,
                                    endText: arr[j].endText,
                                    alexa: obj[i].idAlexa,
                                    sayit: obj[i].idsayit,
                                    whatsapp: obj[i].idWhatsapp,
                                    telegram: obj[i].idTelegram,
                                    pushover: obj[i].idPushover,
                                    email: obj[i].idEmail,
                                    autoOff: obj[i].autoOff,
                                    timer: obj[i].idTimer,
                                    abort: obj[i].abort,
                                    id: obj[i].id
                                };
                            };
                        };
                    };
                };
                return objTemp;
            };
            callback(obj);
        };

        async function clickButton(onChange) {

            varTrue = true;

            // refresh dynamic table
            $('#fill-dynamic-table').on('click', () => {
                $('#dynamicTableLoading, #dynamicTableLoadingText').css('display', ''); // ladekringel
                settings = createSettings();
                load(settings, onChange);
                onChange(true);
                $('.btn-save, .btn-save-close').removeClass('disabled');
                $('#fill-dynamic-table').addClass('disabled');

            });

            //check buttons for input
            $('#btn-check-device').on('click', async () => {
                readUser('device');
            });
            $('#btn-check-alexa').on('click', async () => {
                readUser('alexa');
            });
            $('#btn-check-sayit').on('click', async () => {
                readUser('sayit');
            });
            $('#btn-check-whatsapp').on('click', async () => {
                readUser('whatsapp');
            });
            $('#btn-check-pushover').on('click', async () => {
                readUser('pushover');
            });
            $('#btn-check-default-type').on('click', async () => {
                readUser('default');
            });
            $('#btn-check-custom-type').on('click', async () => {
                readUser('custom');
            });
            $('#btn-check-email').on('click', async () => {
                readUser('email');
            });
        };

        async function readUser(val) {

            $('#fill-dynamic-table').removeClass('disabled');

            alexa = [];
            sayit = [];
            devices = [];
            whatsapp = [];
            deviceTypes = [];
            pushover = [];
            firstName = [];

            let deviceTypesDefault;
            let deviceTypesCustom;

            const objCtrl = await { 0: 'device', 1: 'telegram', 2: 'alexa', 3: 'sayit', 4: 'whatsapp', 5: 'pushover', 6: 'email', 7: 'default', 8: 'custom' };

            const checked = async (arr, idErr, idHeader, name) => {

                if (arr == null) {
                    $(`#${idErr}`).html(`<div style="display: flex; align-items: center; color: grey;">
                        <i class="material-icons">check_circle_outline</i> <b>no entries found</b> </div>`);
                    // Header innen "config devices"
                    $(`#${idHeader}`).html(`<div class="collapsible-header grey lighten-1"><i class="material-icons">create</i>click here for create your first ${name}</div>`);
                } else if (arr.length >= 1) {
                    $(`#${idErr}`).html(`<div style="display: flex; align-items: center; color: red;">
                        <i class="large material-icons">error_outline</i><span><b>invalid input detected:</b><br> - ${arr.join('<br> - ')}</span></div>`);
                    // Header innen "config devices"
                    $(`#${idHeader}`).html(`<div class="collapsible-header red lighten-1"><i class="material-icons">create</i>${arr.length} error(s) found in ${name}</div>`);
                    // Header außen "config devices"
                    $(`#header-config`).html(`<div class="collapsible-header red lighten-1"><i class="material-icons">create</i>Erros(s) found in configuration</div>`);
                    $('.btn-save, .btn-save-close').addClass('disabled');
                } else {
                    $(`#${idErr}`).html(`<div style="display: flex; align-items: center; color: green;">
                        <i class="material-icons">check_circle_outline</i> <b>Input checked</b> </div>`);
                    // Header innen "config devices"
                    $(`#${idHeader}`).html(`<div class="collapsible-header green lighten-1"><i class="material-icons">create</i>Click here to edit your ${name}</div>`);
                    // Header außen "config devices"
                    $(`#header-config`).html(`<div class="collapsible-header green lighten-1"><i class="material-icons">create</i>Click here to create or edit your devices, messenger, etc</div>`);
                    // Header "link devices"
                    $(`#header-link-device`).html(`<div class="collapsible-header green lighten-1"><i class="material-icons">create</i>Here you can link your devices</div>`);
                };
            };


            // 

            // All entries from the Admin are checked here
            const ctrlInput = async (val) => {
                const name = await `${val}`;
                const header = await `header-${val}`;
                switch (val) {
                    case 'start': {
                        for (const i in objCtrl) {
                            await ctrlInput(objCtrl[i]);
                        };
                        await $('.btn-save, .btn-save-close').addClass('disabled');
                        break;
                    }
                    case 'telegram': {
                        sendTo(null, { cmd: 'telegram' }, telegram_counter, async data => {
                            if (data != undefined)
                                firstName = await data;
                        });
                        break;
                    };
                    case 'device': {
                        if (deviceID.length > 0) {
                            sendTo(null, { cmd: 'val', 1: 'name', 2: 'consumption', 3: 'switch', cntr: 3 }, deviceID, async data => {
                                if (data != undefined) {
                                    devices = await data.checked;
                                    await checked(await data.failed, `errDevice`, header, `${name}s`);
                                };
                            });
                        } else await checked(null, `errDevice`, header, name);
                        break;
                    };
                    case 'alexa': {
                        if (alexaID.length > 0) {
                            sendTo(null, { cmd: 'val', 1: 'name', 2: 'path', cntr: 2 }, alexaID, async data => {
                                if (data != undefined) {
                                    alexa = await data.checked;
                                    await checked(await data.failed, `errAlexa`, header, `${name} device`);
                                };
                            });
                        } else await checked(null, `errAlexa`, header, `${name} device`);
                        break;
                    };
                    case 'sayit': {
                        if (sayitID.length > 0) {
                            sendTo(null, { cmd: 'val', 1: 'name', 2: 'path', cntr: 2 }, sayitID, async data => {
                                if (data != undefined) sayit = await data.checked;
                                await checked(await data.failed, `errSayIt`, header, `${name} device`);
                            });
                        } else await checked(null, `errSayIt`, header, `${name} device`);
                        break;
                    };
                    case 'whatsapp': {
                        if (whatsappID.length > 0) {
                            sendTo(null, { cmd: 'val', 1: 'name', 2: 'path', cntr: 2 }, whatsappID, async data => {
                                if (data != undefined) whatsapp = await data.checked;
                                await checked(await data.failed, `errWhatsapp`, header, `${name} user`);
                            });
                        } await checked(null, `errWhatsapp`, header, `${name} user`);
                        break;
                    };
                    case 'pushover': {
                        if (pushoverID.length > 0) {
                            sendTo(null, { cmd: 'val', 1: 'name', cntr: 1 }, pushoverID, async data => {
                                if (data != undefined) pushover = await data.checked;
                                await checked(await data.failed, `errPushover`, header, `${name} user`);
                            });
                        } else await checked(null, `errPushover`, header, `${name} user`);
                        break;
                    };
                    case 'email': {
                        if (emailID.length > 0) {
                            sendTo(null, { cmd: 'email', 1: 'name', 2: 'emailFrom', 3: 'emailTo', cntr: 3 }, emailID, async data => { 
                                if (data != undefined) email = await data.checked;
                                await checked(await data.failed, `errEmail`, header, `${name} user`);
                                console.warn(data);
                            });
                        } else await checked(null, `errEmail`, header, `${name} user`);
                        break;
                    };
                    case 'default': {
                        await pushTypes(defaultTypeID, header, name, 'errDefault');
                        break;
                    };
                    case 'custom': {
                        await pushTypes(customTypeID, header, name, 'errCustom');
                        break;
                    };
                    default: {
                        console.warn('wrong input');
                        break;
                    };
                };
            };

            async function pushTypes(arr, header, name, err) {
                if (arr.length > 0) {
                    sendTo(null, { cmd: 'type', 1: 'name', 2: 'startVal', 3: 'endVal', 4: 'startCount', 5: 'endCount', cntr: 5 }, arr, async data => {
                        if (data != undefined) {
                            $.each(await data.checked, async (index, element) => {
                                deviceTypes.push(`${element.name}`);
                            });
                            await $('#deviceTypeID').attr("data-options", deviceTypes.join(';'));
                        };
                        await checked(await data.failed, err, header, `${name} type config`);
                    });
                } else await checked(null, err, header, `${name} type config`);
            };

            await ctrlInput(val);

        };

        function createDynamicTable(settings, onChange, device) {
            $('#dynamic-table-body').html("");
            for (const i in devices) {
                let ID = devices[i].name;
                let deviceId = devices[i].id;
                curDevice = null
                let data = {};

                device.forEach(function (d) {
                    if (d.deviceName == ID)
                        curDevice = d;
                        console.warn(d);
                });

                if (curDevice == null) {
                    curDevice = {
                        enabled: true,
                        deviceName: devices[i].name,
                        idAlexa: 0,
                        idsayit: 0,
                        idWhatsapp: 0,
                        idTelegram: 0,
                        idPushover: 0,
                        idEmail: 0,
                        autoOff: false,
                        idTimer: 0,
                        abort: false,
                        id: -1
                    };
                };

                data = [
                    { type: 'checkbox', name: "enabled", value: curDevice.enabled },
                    { type: 'label', name: "deviceName", value: curDevice.deviceName },
                    { type: 'multiple', data: alexa, name: "idAlexa", value: curDevice.idAlexa },
                    { type: 'multiple', data: sayit, name: "idsayit", value: curDevice.idsayit },
                    { type: 'multiple', data: firstName, name: "idTelegram", value: curDevice.idTelegram },
                    { type: 'multiple', data: whatsapp, name: "idWhatsapp", value: curDevice.idWhatsapp },
                    { type: 'multiple', data: pushover, name: "idPushover", value: curDevice.idPushover },
                    { type: 'multiple', data: email, name: "idEmail", value: curDevice.idEmail },
                    { type: 'checkbox', name: "autoOff", value: curDevice.autoOff },
                    { type: 'timer', name: "idTimer", value: parseInt(curDevice.idTimer) },
                    { type: 'checkbox', name: "abort", value: curDevice.abort },
                    { type: 'id', name: "id", value: parseInt(deviceId) }
                ];

                console.warn(data);

                let col = "<tr>";
                data.forEach(d => {
                    if (d.data == undefined || d.data.length > 0) {
                        let style = "";
                        if (d.name == "deviceName") {
                            style = 'style="font-weight:bold;"';
                        };

                        col += `<td data-type=${d.type} data-name="${d.name}" ${style}>`;
                        switch (d.type) {
                            case 'checkbox':
                                let checked = '';
                                if (d.value == true || d.value == 'on') {
                                    checked = 'checked="checked"';
                                }
                                col += `<label><input type="checkbox" class="values-input" ${checked} data-old-value="${d.value}"><span></span></label>`;
                                break;
                            case 'label':
                                col += `<span class="values-input" data-old-value="${d.value}">${d.value}</span>`;
                                break;
                            case 'multiple':
                                col += `<select multiple class="values-input" data-old-value="${d.value}">`;
                                d.data.forEach(name => {
                                    let checked = '';
                                    if ($.inArray(name, d.value))
                                        checked = 'selected';
                                    col += `<option ${checked} value='${name.id}'>${name.name}</option>`
                                });
                                col += `</select>`;
                                break;
                            case 'timer':
                                col += `<input type="number" min="0" class="values-input" data-old-value="${d.value}">`;
                                break;
                            case 'id':
                                col += `<span class="values-input" data-old-value="${d.value}">${d.value}</span>`;
                                break;
                            default:
                                col += `Test`;
                                break;
                        };
                        col += `</td>`;
                    };
                });
                col += "</tr>";
                $('#dynamic-table-body').append(col);

                $('#dynamic-table-body').children().eq(i).children().each(function () {
                    if ($(this).data('type') == 'multiple') {
                        $(this).find('select').val(curDevice[$(this).data('name')]);
                    }
                    else {
                        $(this).find('input').val(curDevice[$(this).data('name')]);
                    }
                });

                $('#dynamic-table-body').find('.values-input').on('change', function () {
                    if ($(this).val() != $(this).data('old-value')) {
                        onChange();
                    };
                });
            };
            if (curDevice != null) {
                let selectInstance = M.FormSelect.getInstance($('select'));
                instances = M.FormSelect.init($('select'));
                M.updateTextFields();
            };

            if (settings != null && settings != undefined)
                loadUser(settings, onChange);

        };

        function createSettings() {

            let obj = {};
            obj.deviceID = null;
            obj.deviceID = table2values('deviceID');
            obj.alexaID = table2values('alexaID');
            obj.sayitID = table2values('sayitID');
            console.log(firstName);
            obj.telegramID = firstName; // telegram namen sichern

            obj.whatsappID = table2values('whatsappID');
            obj.customTypeID = table2values('customTypeID');
            obj.defaultTypeID = table2values('defaultTypeID');
            obj.valStates = table2values('valStates');
            obj.pushoverID = table2values('pushoverID');
            obj.emailID = table2values('emailID'); 

            obj.deviceID = createId(obj.deviceID, device_counter, "device_counter");
            obj.alexaID = createId(obj.alexaID, alexa_counter, "alexa_counter");
            obj.sayitID = createId(obj.sayitID, sayit_counter, "sayit_counter");
            obj.whatsappID = createId(obj.whatsappID, whatsapp_counter, "whatsapp_counter");
            obj.pushoverID = createId(obj.pushoverID, pushover_counter, "pushover_counter");
            obj.emailID = createId(obj.emailID, email_counter, "email_counter");


            function createId(array, counter, counter_name) {
                for (const i in array) {
                    if (array[i].id == "") {
                        array[i].id = counter;
                        counter++;
                    };
                };
                obj[counter_name] = counter;
                return array;
            };

            let body = $('#dynamic-table-body');
            let geraete = [];

            body.children().each(function () {

                let data = {};
                $(this).children().each(function () {
                    let value;
                    if ($(this).data('type') == 'multiple') {
                        value = $(this).find('select').val();
                        $(this).find('select').data('old-value', value);
                    }
                    else if ($(this).data('type') == 'label') {
                        value = $(this).find('span').text();
                    }
                    else if ($(this).data('type') == 'checkbox') {
                        value = $(this).find('input').prop('checked');
                        $(this).find('input').data('old-value', value);
                    }
                    else if ($(this).data('type') == 'id') {
                        value = $(this).find('span').text();
                    }
                    else {
                        value = $(this).find('input').val();
                        $(this).find('input').data('old-value', value);
                    };
                    data[$(this).data('name')] = value;

                });
                geraete.push(data);
            });
            obj.device = geraete;
            return obj;
        };

        function showHeader(tblId, columnName, arr) {
            if (arr.length > 0) {
                $('#' + tblId + ' [data-name="' + columnName + '"]').css('display', 'table-cell');
            }
            else {
                $('#' + tblId + ' [data-name="' + columnName + '"]').css('display', 'none');
            }
        }

    </script>
</head>

<body>
    <div class="m adapter-container">
        <div class="row" id="test">
            <!-- Tabs: Menu -->
            <div class="col s12 .tabs-fixed-width"
                style="padding-left:0;padding-right:0; margin-top: 0px; margin-bottom: 1px; background-color:#174475; box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);">
                <ul class="tabs blue lighten-4">
                    <li class="tab col s3"><a href="#tab-config" class="translate">Config</a></li>
                    <li class="tab col s3"><a href="#tab-devices" class="translate">Devices</a></li>
                </ul>
            </div>

            <div class="row">
                <!-- Tab with id "config" -->
                <div id="tab-config" class="col s12">
                    <div class="row">
                        <div class="row">
                            <div class="input-field col s3">
                                <img src="icon.png">
                            </div>
                        </div>


                        <div>
                            <ul class="collapsible">
                                <li>
                                    <div id="header-config">
                                        <!-- text -->
                                    </div>
                                    <div class="collapsible-body blue lighten-5">
                                        <!-- create device -->
                                        <ul class="collapsible">
                                            <li>
                                                <div id="header-device">
                                                    <!-- text -->
                                                </div>
                                                <div class="collapsible-body blue lighten-5" id="deviceID">
                                                    <div class="row">
                                                        <div style="display: flex; align-items: center;">
                                                            <div class="col left s2">
                                                                <a class="btn-floating waves-effect waves-light blue table-button-add">
                                                                    <i class="material-icons">add_circle_outline</i></a>
                                                                <b>add device</b>
                                                            </div>
                                                            <div class="col s2">
                                                                <a id="btn-check-device" class="waves-effect waves-teal btn">check input</a>
                                                            </div>
                                                            <div class="col s8" id="errDevice">
                                                                <!-- 'text' -->
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <b>*Required fields</b>
                                                    <table class="table-values changeOnChangeEvent remove-last-column">
                                                        <thead>
                                                            <tr>
                                                                <th data-name="_index" style="width: 40px" class="header translate">nr</th>
                                                                <th data-name="name" data-type="text" class="header translate">*device name</th>
                                                                <th id="deviceTypeID" data-name="type" style="width: 200px;" data-type="select" style="width: 150px" class="header translate" data-options="">*device type</th>
                                                                <th data-name="consumption" data-type="OID" class="header translate"> *path<br>consumption/energy</th>
                                                                <th data-name="switch" data-type="OID" class="header translate">path<br>switch on/off</th>
                                                                <th data-name="startText" data-type="OID" class="header translate">Starttext</th>
                                                                <th data-name="endText" data-type="OID" class="header translate">Endtext</th>
                                                                <th data-buttons="delete" style="width: 80px;" class="header translate">delete</th>
                                                                <th data-name="id" style="width: 0px; display: none;" class="header translate">id</th>
                                                            </tr>
                                                        </thead>
                                                    </table>
                                                </div>
                                            </li>
                                        </ul>

                                        <!-- create alexa device -->
                                        <ul class="collapsible">
                                            <li>
                                                <div id="header-alexa">
                                                    <!-- text -->
                                                </div>
                                                <div class="collapsible-body blue lighten-5" id="alexaID">
                                                    <div class="row">
                                                        <div style="display: flex; align-items: center;">
                                                            <div class="col left s2">
                                                                <a class="btn-floating waves-effect waves-light blue table-button-add">
                                                                    <i class="material-icons">add_circle_outline</i></a>
                                                                <b>add device</b>
                                                            </div>
                                                            <div class="col s2">
                                                                <a id="btn-check-alexa" class="waves-effect waves-light btn">check input</a>
                                                            </div>
                                                            <div class="col s8" id="errAlexa">
                                                                <!-- 'text' -->
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <b>*Required fields</b>
                                                    <table class="table-values changeOnChangeEvent remove-last-column">
                                                        <thead>
                                                            <tr>
                                                                <th data-name="_index" style="width: 40px" class="header translate">nr</th>
                                                                <th data-name="name" data-type="text" class="header translate">*alexa name</th>
                                                                <th data-name="path" data-type="OID" class="header translate">*alexa path<br>"announcement"/"speak"</th>
                                                                <th data-name="volume" style="width: 80px" data-type="number" class="header translate" data-default="50">volume <br> 0-100</th>
                                                                <th data-name="timeMinHour" style="width: 80px" data-type="select" class="header translate" data-default="0" data-options="0;1;2;3;4;5;6;7;8;9;10;11;12;13;14;15;16;17;18;19;20;21;22;23">time <br>active hour</th>
                                                                <th data-name="timeMinMin" style="width: 80px" data-type="select" class="header translate" data-default="00" data-options="00;15;30;45">time<br>active min</th>
                                                                <th data-name="timeMaxHour" style="width: 80px" data-type="select" class="header translate" data-default="23" data-options="0;1;2;3;4;5;6;7;8;9;10;11;12;13;14;15;16;17;18;19;20;21;22;23">time <br>inactive hour</th>
                                                                <th data-name="timeMaxMin" style="width: 80px" data-type="select" class="header translate" data-default="59" data-options="00;15;30;45;59">time<br>inactive min</th>
                                                                <th data-buttons="delete" style="width: 80px" class="header translate">delete</th>
                                                                <th data-name="id" style="width: 0px; display: none;" class="header translate">id</th>
                                                            </tr>
                                                        </thead>
                                                    </table>
                                                </div>
                                            </li>
                                        </ul>

                                        <!-- create sayit User -->
                                        <ul class="collapsible">
                                            <li>
                                                <div id="header-sayit">
                                                    <!-- text -->
                                                </div>
                                                <div class="collapsible-body blue lighten-5" id="sayitID">
                                                    <div class="row">
                                                        <div style="display: flex; align-items: center;">
                                                            <div class="col left s2">
                                                                <a class="btn-floating waves-effect waves-light blue table-button-add">
                                                                    <i class="material-icons">add_circle_outline</i></a>
                                                                <b>add device</b>
                                                            </div>
                                                            <div class="col s2">
                                                                <a id="btn-check-sayit" class="waves-effect waves-light btn">check input</a>
                                                            </div>
                                                            <div class="col s8" id="errSayIt">
                                                                <!-- 'text' -->
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <b>*Required fields</b>
                                                    <table class="table-values changeOnChangeEvent remove-last-column">
                                                        <thead>
                                                            <tr>
                                                                <th data-name="_index" style="width: 40px" class="header translate">nr</th>
                                                                <th data-name="name" data-type="text" class="header translate">*sayit name</th>
                                                                <th data-name="path" data-type="OID" class="header translate">*sayit path<br>"../text"</th>
                                                                <th data-name="volume" style="width: 80px" data-type="number" class="header translate" data-default="50">volume <br> 0-100</th>
                                                                <th data-name="timeMinHour" style="width: 80px" data-type="select" class="header translate" data-default="0" data-options="0;1;2;3;4;5;6;7;8;9;10;11;12;13;14;15;16;17;18;19;20;21;22;23">time<br>active hour</th>
                                                                <th data-name="timeMinMin" style="width: 80px" data-type="select" class="header translate" data-default="00" data-options="00;15;30;45">time<br>active min</th>
                                                                <th data-name="timeMaxHour" style="width: 80px" data-type="select" class="header translate" data-default="23" data-options="0;1;2;3;4;5;6;7;8;9;10;11;12;13;14;15;16;17;18;19;20;21;22;23">time <br>inactive hour</th>
                                                                <th data-name="timeMaxMin" style="width: 80px" data-type="select" class="header translate" data-default="59" data-options="00;15;30;45;59"><br>inactive min</th>
                                                                <th data-buttons="delete" style="width: 80px" class="header translate">delete</th>
                                                                <th data-name="id" style="width: 0px; display: none;" class="header translate">id</th>
                                                            </tr>
                                                        </thead>
                                                    </table>
                                                </div>
                                            </li>
                                        </ul>

                                        <!-- create whatsapp user -->
                                        <ul class="collapsible">
                                            <li>
                                                <div id="header-whatsapp">
                                                    <!-- text -->
                                                </div>
                                                <div class="collapsible-body blue lighten-5" id="whatsappID">
                                                    <div class="row">
                                                        <div style="display: flex; align-items: center;">
                                                            <div class="col left s2">
                                                                <a class="btn-floating waves-effect waves-light blue table-button-add">
                                                                    <i class="material-icons">add_circle_outline</i></a>
                                                                <b>add device</b>
                                                            </div>
                                                            <div class="col s2">
                                                                <a id="btn-check-whatsapp" class="waves-effect waves-light btn">check input</a>
                                                            </div>
                                                            <div class="col s8" id="errWhatsapp">
                                                                <!-- 'text' -->
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <b>*Required fields</b>
                                                    <table class="table-values changeOnChangeEvent remove-last-column">
                                                        <thead>
                                                            <tr>
                                                                <th data-name="_index" style="width: 40px" class="header translate">nr</th>
                                                                <th data-name="name" data-type="text" class="header translate">*whatsapp name</th>
                                                                <th data-name="path" data-type="OID" class="header translate">*whatsapp path<br>"sendMessage"</th>
                                                                <th data-buttons="delete" style="width: 80px" class="header translate">delete</th>
                                                                <th data-name="id" style="width: 0px; display: none;" class="header translate">id</th>
                                                            </tr>
                                                        </thead>
                                                    </table>
                                                </div>
                                            </li>
                                        </ul>

                                        <!-- create Pusherover User -->
                                        <ul class="collapsible">
                                            <li>
                                                <div id="header-pushover">
                                                    <!-- text -->
                                                </div>
                                                <div class="collapsible-body blue lighten-5" id="pushoverID">
                                                    <div class="row">
                                                        <div style="display: flex; align-items: center;">
                                                            <div class="col left s2">
                                                                <a class="btn-floating waves-effect waves-light blue table-button-add">
                                                                    <i class="material-icons">add_circle_outline</i></a>
                                                                <b>add device</b>
                                                            </div>
                                                            <div class="col s2">
                                                                <a id="btn-check-pushover" class="waves-effect waves-light btn">check input</a>
                                                            </div>
                                                            <div class="col s8" id="errPushover">
                                                                <!-- 'text' -->
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <b>*Required fields</b>
                                                    <table class="table-values changeOnChangeEvent remove-last-column">
                                                        <thead>
                                                            <tr>
                                                                <th data-name="_index" style="width: 40px" class="header translate">nr</th>
                                                                <th data-name="name" data-type="text" class="header translate"> *pushover name</th>
                                                                <th data-name="inst" data-type="select" class="header translate" data-default=".0" data-options=".0;.1;.2;.3;.4;.5">*pushover instance</th>
                                                                <th data-name="prio" data-type="select" class="header translate" data-default="normal" data-options="normal; high; quiet">priority </th>
                                                                <th data-name="sound" data-type="select" class="header translate" data-default="pushover" data-options="pushover; bike; bugle; cashregister; classical; cosmic; falling; gamelan; incoming; intermission; magic; mechanical; pianobar; siren; spacealarm; tugboat; alien; climb; persistent; echo; updown; none">sound </th>
                                                                <th data-buttons="delete" style="width: 80px" class="header translate">delete</th>
                                                                <th data-name="id" style="width: 0px; display: none;" class="header translate">id </th>
                                                            </tr>
                                                        </thead>
                                                    </table>
                                                </div>
                                            </li>
                                        </ul>

                                        <!-- create email User -->
                                        <ul class="collapsible">
                                                <li>
                                                    <div id="header-email">
    
                                                    </div>
                                                    <div class="collapsible-body blue lighten-5" id="emailID">
                                                        <div class="row">
                                                            <div style="display: flex; align-items: center;">
                                                                <div class="col left s2">
                                                                    <a class="btn-floating waves-effect waves-light blue table-button-add">
                                                                        <i class="material-icons">add_circle_outline</i></a>
                                                                    <b>add device</b>
                                                                </div>
                                                                <div class="col s2">
                                                                    <a id="btn-check-email" class="waves-effect waves-light btn">check input</a>
                                                                </div>
                                                                <div class="col s8" id="errEmail">
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <b>*Required fields</b>
                                                        <table class="table-values changeOnChangeEvent remove-last-column">
                                                            <thead>
                                                                <tr>
                                                                    <th data-name="_index" style="width: 40px" class="header translate">nr</th>
                                                                    <th data-name="name" data-type="text" class="header translate">*Name</th>
                                                                    <th data-name="emailFrom" data-type="text" class="header translate">*Email address "from"</th>
                                                                    <th data-name="emailTo" data-type="text" class="header translate">*Email address "to"</th>
                                                                    <th data-buttons="delete" style="width: 80px" class="header translate">delete</th>
                                                                    <th data-name="id" style="width: 0px; display: none;" class="header translate">id</th>
                                                                </tr>
                                                            </thead>
                                                        </table>
                                                    </div>
                                                </li>
                                            </ul>

                                        <!-- create Default Type -->
                                        <ul class="collapsible">
                                            <li>
                                                <div id="header-default">
                                                    <!-- text -->
                                                </div>
                                                <div class="collapsible-body blue lighten-5" id="defaultTypeID">
                                                    <div class="row">
                                                        <div style="display: flex; align-items: center;">
                                                            <div>
                                                                <a id="btn-check-default-type" class="waves-effect waves-light btn">check input</a>
                                                            </div>
                                                            <div class="col s10" id="errDefault">
                                                                <!-- 'text' -->
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <h3>default devices</h3>
                                                    </div>
                                                    <table id="disableFirstField" class="table-values remove-last-column">
                                                        <thead>
                                                            <tr>
                                                                <th id="disableFirstField" class="header translate"data-type="text" data-name="name">type name</th>
                                                                <th class="header translate" data-type="number" data-name="startVal">Starting value</th>
                                                                <th class="header translate" data-type="number" data-name="endVal">Final value</th>
                                                                <th class="header translate" data-type="number" data-name="startCount">Number of values "start"</th>
                                                                <th class="header translate" data-type="number" data-name="endCount"> Number of values ​"end"</th>
                                                                <th class="header translate" data-type="number" data-name="id" style="width: 0px; display: none;">id</th>
                                                            </tr>
                                                        </thead>
                                                    </table>
                                                </div>
                                            </li>
                                        </ul>

                                        <!-- create Custom Type -->
                                        <ul class="collapsible">
                                            <li>
                                                <div id="header-custom">
                                                    <!-- text -->
                                                </div>
                                                <div class="collapsible-body blue lighten-5" id="customTypeID">
                                                    <div class="row">
                                                        <div style="display: flex; align-items: center;">
                                                            <div class="col left s2">
                                                                <a class="btn-floating waves-effect waves-light blue table-button-add">
                                                                    <i class="material-icons">add_circle_outline</i></a>
                                                                <b>add device</b>
                                                            </div>
                                                            <div class="col s2">
                                                                <a id="btn-check-custom-type" class="waves-effect waves-light btn">check input</a>
                                                            </div>
                                                            <div class="col s8" id="errCustom">
                                                                <!-- 'text' -->
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <h3>default devices</h3>
                                                    </div>
                                                    <table id="disableFirstField" class="table-values remove-last-column">
                                                        <thead>
                                                            <tr>
                                                                <th id="disableFirstField" class="header translate" data-type="text" data-name="name">type name</th>
                                                                <th class="header translate" data-type="number" data-name="startVal">Starting value</th>
                                                                <th class="header translate" data-type="number" data-name="endVal">Final value</th>
                                                                <th class="header translate" data-type="number" data-name="startCount">Number of values "start"</th>
                                                                <th class="header translate" data-type="number" data-name="endCount">Number of values ​"end"</th>
                                                                <th data-buttons="delete" style="width: 80px" class="header translate">delete</th>
                                                                <th class="header translate" data-type="number" data-name="id" style="width: 0px; display: none;">id</th>
                                                            </tr>
                                                        </thead>
                                                    </table>
                                                </div>
                                            </li>
                                        </ul>




                                    </div>
                                </li>
                            </ul>
                        </div>


                        <!-- link devices -->
                        <div>
                            <ul class="collapsible">
                                <li>
                                    <div id="header-link-device">
                                        <!-- text -->
                                    </div>
                                    <div class="collapsible-body blue lighten-5" id="device">
                                        <div class="row">
                                            <div style="display: flex; align-items: center;">
                                                <div>
                                                    <a id="fill-dynamic-table" class="waves-effect waves-teal btn">refresh table</a>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="card-panel blue lighten-5">
                                            <table id="dynamicTable" class="table-values changeOnChangeEvent remove-last-column">
                                                <thead>
                                                    <tr>
                                                        <th class="header translate" data-name="enabled" style="width: 60px">active</th>
                                                        <th class="header translate" data-name="deviceName">device name</th>
                                                        <th class="header translate" data-name="idAlexa">Device alexa</th>
                                                        <th class="header translate" data-name="idsayit">Device SayIt</th>
                                                        <th class="header translate" data-name="idTelegram">telegram user</th>
                                                        <th class="header translate" data-name="idWhatsapp">whatsapp user</th>
                                                        <th class="header translate" data-name="idPushover">pushover user</th>
                                                        <th class="header translate" data-name="idEmail">email</th>
                                                        <th class="header translate" data-name="autoOff" style="width: 60px">autooff</th>
                                                        <th class="header translate" data-name="idTimer" style="width: 60px">timeout in min</th>
                                                        <th class="header translate" data-name="abort" style="width: 80px">abort<br>detection</th>
                                                        <th class="header translate" data-name="id" style="width: 0px; display: none;">id</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="dynamic-table-body" class="table-values">
                                                </tbody>
                                            </table>
                                            <div id="dynamicTableLoading" class="preloader-wrapper big active"
                                                style="margin: auto">
                                                <div class="spinner-layer spinner-blue-only">
                                                    <div class="circle-clipper left">
                                                        <div class="circle"></div>
                                                    </div>
                                                    <div class="gap-patch">
                                                        <div class="circle"></div>
                                                    </div>
                                                    <div class="circle-clipper right">
                                                        <div class="circle"></div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div id="dynamicTableLoadingText" style="margin: auto">
                                                Please wait while table is loading
                                            </div>
                                        </div>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab id "devices" -->
            <div id="tab-devices" class="col s12">
                <div class="row">
                    <div class="col s12" id="device">
                        <div class="row">
                            <div class="input-field col s3">
                                <img src="icon.png">
                            </div>
                        </div>

                        <div class="row">
                            <div id="valStates">
                                <div class="col s6">
                                    <div class="card">
                                        <div class="card-panel blue lighten-5">
                                            <div>
                                                <h5>Configure your own device status</h5>
                                            </div>
                                            <table class="table-values changeOnChangeEvent remove-first-column">
                                                <thead>
                                                    <tr>
                                                        <th class="header translate" style="width: 0px; display: none;">
                                                        </th>
                                                        <th class="header translate" data-type="text"
                                                            data-name="stateAction">status: "in action"</th>
                                                        <th class="header translate" data-type="text"
                                                            data-name="stateStandby">status: "in standby"</th>
                                                        <th class="header translate" data-type="text"
                                                            data-name="stateOff">status: "devic eoff"</th>
                                                    </tr>
                                                </thead>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

        </div>
    </div>

    <div class="m material-dialogs">
        <div id="dialog-select-member" class="modal modal-fixed-footer">
            <div class="modal-content">
                <div class="row">
                    <div class="col s12 title"></div>
                </div>
                <div class="row">
                    <div class="col s12 dialog-content"></div>
                </div>
            </div>
            <div class="modal-footer">
                <a class="modal-action modal-close waves-effect waves-green btn btn-set"><i
                        class="large material-icons left">check</i><span class="translate">Select</span></a>
                <a class="modal-action modal-close waves-effect waves-green btn btn-close"><i
                        class="large material-icons left ">close</i><span class="translate">Cancel</span></a>
            </div>
        </div>
    </div>
</body>

</html>